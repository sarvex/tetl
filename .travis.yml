branches:
  only:
    - main

language: cpp

script-anchors:
  - &script-coverage
    - cd $TRAVIS_BUILD_DIR
    - make coverage
    - bash <(curl -s https://codecov.io/bash) -f cmake-build-coverage/cov.info

  - &script-docs
    - cd $TRAVIS_BUILD_DIR
    - doxygen Doxyfile.in

  - &script-sanitizers
    - cd $TRAVIS_BUILD_DIR
    - mkdir build
    - cd build
    - cmake .. -DCMAKE_BUILD_TYPE:STRING=Release -DTETL_BUILD_ASAN=ON -DTETL_BUILD_UBSAN=ON -DTETL_BUILD_CPP20=ON
    - cmake --build . -- -j
    - ctest -j

matrix:
  include:
    - os: linux
      dist: focal
      addons:
        apt:
          packages:
            - ninja-build
            - lcov
      env:
        - MATRIX_EVAL="CC=gcc && CXX=g++"
      script: *script-coverage

    - os: linux
      dist: focal
      addons:
        apt:
          sources:
            - sourceline: "ppa:ubuntu-toolchain-r/test"
            - sourceline: "deb https://apt.llvm.org/focal/ llvm-toolchain-focal-12 main"
              key_url: "https://apt.llvm.org/llvm-snapshot.gpg.key"
          packages:
            - ninja-build
            - clang++-12
      env:
        - MATRIX_EVAL="CC=clang-12 && CXX=clang++-12"
      script: *script-sanitizers

    - os: linux
      dist: focal
      addons:
        apt:
          sources:
            - sourceline: "ppa:ubuntu-toolchain-r/test"
            - sourceline: "deb https://apt.llvm.org/focal/ llvm-toolchain-focal-12 main"
              key_url: "https://apt.llvm.org/llvm-snapshot.gpg.key"
          packages:
            - ninja-build
            - doxygen
            - graphviz
      env:
        - MATRIX_EVAL="CC=gcc && CXX=g++"
      script: *script-docs
      # deploy:
      #   provider: pages
      #   skip_cleanup: true
      #   local_dir: build-doc/html
      #   github_token: $GITHUB_TOKEN
      #   keep_history: true
      #   on:
      #     branch: main

before_install:
  - eval "${MATRIX_EVAL}"
